name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run linting
        run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

  # This job will only succeed if all other jobs succeed
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "âŒ Linting failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… All checks passed!"

      - name: Comment on PR failure
        if: failure() && github.event_name == 'pull_request'
        env:
          COMMENT_BODY: |
            ## âŒ **CI Checks Failed**

            The following checks failed:
            ${{ needs.lint.result != 'success' && '- Linting (For linting issues: Run `npm run lint` locally)' || '' }}
            ${{ needs.build.result != 'success' && '- Build (For build issues: Run `npm run build ./...` locally)' || '' }}

            _Please fix the issues before merging this PR._

            ---

            > **Details:**
            > - **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            > - **Branch:** `${{ github.head_ref || github.ref_name }}`
            > - **Triggered by:** @${{ github.actor }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
          header: CI-MONITOR
          message: ${{ env.COMMENT_BODY }}

      - name: Comment on PR success
        if: success() && github.event_name == 'pull_request'
        env:
          COMMENT_BODY: |
            ## âœ… **All CI Checks Passed**

            All checks have passed successfully. Thank you for contributing to the project âœŒðŸ¼!

            ---

            > **Details:**
            > - **Commit:** (https://github.com/${{ github.repository }}/commit/${{ github.sha }})
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
          header: CI-MONITOR
          message: ${{ env.COMMENT_BODY }}
